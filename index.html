<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>RIX ‚Äî Raebareli Industrial Network</title>
<meta name="description" content="Independent Industrial Business Network ‚Äî controlled by Google Sheet" />
<meta name="theme-color" content="#020617" />

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&family=JetBrains+Mono:wght@700&display=swap" rel="stylesheet">

<!-- PapaParse (robust CSV) -->
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

<style>
:root{
  --bg:#020617; --surface:#0f172a; --surface-2:#1e293b;
  --border:rgba(255,255,255,.08); --text:#f8fafc; --muted:#94a3b8;
  --primary:#3b82f6; --gold:#fbbf24; --green:#10b981; --danger:#ef4444;
  --glass:rgba(15,23,42,.8); --radius:18px; --shadow:0 20px 40px rgba(0,0,0,.5);
  --max-width:1100px;
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:'Plus Jakarta Sans',system-ui,-apple-system; background:var(--bg); color:var(--text);
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; padding-bottom:140px;
}
.container{max-width:var(--max-width);margin:0 auto}

/* Header */
.header{
  padding:90px 20px 110px; text-align:center; border-bottom:1px solid var(--border);
  background:radial-gradient(circle at top right,#1e3a8a,transparent 60%), linear-gradient(180deg,#020617,#0f172a);
}
.header .badge{display:inline-block;background:rgba(59,130,246,.08); color:var(--primary); padding:8px 18px; border-radius:999px; font-weight:800; font-size:12px; letter-spacing:2px}
.header h1{font-size:54px;margin-top:14px;font-weight:800}
.header p{color:var(--muted);margin-top:10px;font-weight:700;letter-spacing:3px;font-size:12px}

/* Stats */
.stats{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;padding:0 20px;margin-top:-50px}
@media(min-width:800px){.stats{grid-template-columns:repeat(4,1fr)}}
.stat{background:var(--glass);backdrop-filter:blur(12px);border:1px solid var(--border);border-radius:14px;padding:18px;text-align:center;box-shadow:var(--shadow)}
.stat strong{display:block;font-family:'JetBrains Mono',monospace;font-size:28px}

/* Controls */
.controls{padding:28px 20px 6px}
.search{display:flex;gap:12px;max-width:var(--max-width);margin:0 auto}
.search input{flex:1;padding:14px 16px;border-radius:14px;border:1px solid var(--border);background:var(--surface);color:var(--text);font-weight:600}
.btn{padding:12px 14px;border-radius:12px;background:var(--primary);color:#fff;font-weight:800;border:none;cursor:pointer}
.small{padding:10px 12px;font-size:13px}
.filters{display:flex;gap:10px;overflow:auto;padding:14px 20px;max-width:var(--max-width);margin:0 auto}
.chip{padding:10px 16px;border-radius:999px;background:var(--surface);border:1px solid var(--border);font-weight:700;color:var(--muted);cursor:pointer;white-space:nowrap}
.chip.active{background:var(--primary);color:#fff;border-color:var(--primary)}

/* List */
#list{padding:20px;display:grid;gap:20px;max-width:var(--max-width);margin:0 auto}
@media(min-width:900px){#list{grid-template-columns:repeat(2,1fr)}}
.card{background:var(--surface);border:1px solid var(--border);border-radius:28px;padding:26px;position:relative;overflow:hidden;transition:transform .25s}
.card:hover{transform:translateY(-6px)}
.card.premium{border:2px solid var(--gold);background:linear-gradient(145deg,#1e293b,#020617)}
.card .tag-row{display:flex;flex-wrap:wrap;gap:8px;margin:12px 0}
.tag{font-size:11px;padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:rgba(255,255,255,.02);color:var(--muted);font-weight:800}
.tag.verified{color:var(--green);border-color:var(--green);background:rgba(16,185,129,.06)}
.tag.expired{color:var(--danger);border-color:var(--danger);background:rgba(239,68,68,.06)}
.title{font-size:22px;font-weight:800;display:flex;align-items:center;gap:10px}
.loc{color:var(--muted);font-size:13px;margin-top:6px}
.rating{display:flex;justify-content:space-between;align-items:center;background:rgba(0,0,0,.18);padding:12px;border-radius:12px;margin-top:12px}
.stars{color:var(--gold);font-weight:900}
.actions{display:grid;grid-template-columns:1fr 64px;gap:10px;margin-top:14px}
.call{background:var(--primary);color:#fff;padding:12px;border-radius:12px;text-align:center;font-weight:800}
.wa{background:#25d366;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px;color:#fff}

/* Admin small */
.admin-box{margin-top:14px;padding:12px;border-radius:10px;background:rgba(0,0,0,.25);border:1px dashed var(--border);font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--muted)}
.hidden{display:none}

/* Nav */
nav{position:fixed;left:20px;right:20px;bottom:24px;background:var(--glass);backdrop-filter:blur(20px);border:1px solid var(--border);border-radius:40px;padding:12px 18px;display:flex;justify-content:space-around;align-items:center;box-shadow:0 30px 60px rgba(0,0,0,.6)}
nav a{color:var(--muted);font-weight:800;font-size:12px;text-decoration:none}
.add-btn{background:var(--primary);width:68px;height:68px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:30px;color:#fff;margin-top:-36px;border:8px solid var(--bg)}
.loader{height:180px;background:linear-gradient(90deg,#0f172a 25%,#1e293b 50%,#0f172a 75%);border-radius:22px;animation:shimmer 1.8s linear infinite;background-size:1200px 100%}
.footer-note{max-width:var(--max-width);margin:34px auto;color:var(--muted);font-size:12px;padding:0 20px;text-align:center}
</style>
</head>
<body>
  <div class="container header">
    <div class="badge">Independent Hub 2026</div>
    <h1>RIX</h1>
    <p>Raebareli Industrial Network</p>
  </div>

  <div class="container stats" aria-hidden="false">
    <div class="stat"><strong id="totalCount">0</strong><span>Total Units</span></div>
    <div class="stat"><strong id="verifiedCount">0</strong><span>Verified</span></div>
    <div class="stat"><strong id="premiumCount">0</strong><span>Premium (paid)</span></div>
    <div class="stat"><strong id="cityCount">0</strong><span>Hubs/Cities</span></div>
  </div>

  <div class="controls">
    <div class="search container" style="align-items:center;margin-bottom:6px">
      <input id="searchInput" placeholder="Search shop, category, industry, or city..." onkeyup="searchEngine(this.value)" />
      <button class="btn small" id="refreshBtn" title="Refresh data">Refresh</button>
      <button class="btn small" id="adminToggle" title="Show admin (#admin)">Admin</button>
    </div>
    <div class="filters" id="cityFilters"></div>
  </div>

  <main id="list" class="container">
    <div class="loader"></div><div class="loader"></div><div class="loader"></div>
  </main>

  <div class="container footer-note">Tip: Edit the Google Sheet to update listings. Use <code>#admin</code> or <code>?admin=1</code> in the URL to view admin info (agent & payments).</div>

  <nav>
    <a href="#" class="active">üè† Directory</a>
    <a class="add-btn" href="https://wa.me/918146518503?text=Add%20Business%20To%20RIX">Ôºã</a>
    <a href="https://wa.me/918146518503?text=RIX%20Support">üõ°Ô∏è Support</a>
  </nav>

<script>
/* ========== CONFIG ========== */
/* Replace this with your published Google Sheet CSV URL */
const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSV8re2vW-TnHXqnW6LRXuwcU_NJScWKEj-EL9M0Ou6t3CAuUg4oeILRlfllGtVvm6FThUqBhBfsDs4/pub?output=csv";

/* Admin reveal: #admin OR ?admin=1 */
const isAdmin = (() => {
  try {
    const h = location.hash.replace('#','');
    const p = new URLSearchParams(location.search);
    return (h === 'admin') || (p.get('admin') === '1');
  } catch(e){ return false; }
})();

/* State */
let db = [], view = [], currentCity = 'All';

/* Utility: safe access */
const s = v => (v || "").toString().trim();
const num = v => (v === undefined || v === null || v === '') ? 0 : Number(v);

/* sanitize phone digits */
function sanitizePhone(p) {
  if(!p) return "";
  const digits = p.toString().replace(/\D/g,'');
  // ensure 10-digit fallback
  if(digits.length === 10) return digits;
  if(digits.length > 10 && digits.startsWith('91')) return digits.slice(-10);
  return digits;
}

/* create dynamic manifest so PWA install works without extra file */
(function makeManifest(){
  const manifest = {
    "name":"RIX ‚Äî Industrial Directory",
    "short_name":"RIX",
    "start_url":".",
    "display":"standalone",
    "background_color":"#020617",
    "theme_color":"#020617",
    "icons":[{"src":"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 120 120'%3E%3Crect width='120' height='120' rx='24' fill='%233b82f6'/%3E%3Ctext x='50%' y='54%' dominant-baseline='middle' text-anchor='middle' font-size='60' font-family='Arial' fill='white'>R</text%3E%3C/svg%3E","sizes":"120x120","type":"image/svg+xml"}]
  };
  const blob = new Blob([JSON.stringify(manifest)],{type:'application/json'});
  const url = URL.createObjectURL(blob);
  const link = document.createElement('link');
  link.rel = 'manifest'; link.href = url;
  document.head.appendChild(link);
})();

/* ========== LOAD DATA (PapaParse) ========== */
function fetchAndParse() {
  return new Promise((resolve, reject) => {
    Papa.parse(SHEET_URL, {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: results => resolve(results.data),
      error: err => reject(err)
    });
  });
}

/* bootstrap */
async function boot(tryCached=true){
  try {
    const data = await fetchAndParse();
    // normalize: keep only rows with ShopID or Shop name
    db = data.filter(r => s(r.ShopID) || s(r["Shop name"]));
    localStorage.setItem('rix_db_v1', JSON.stringify(db));
    postBoot();
    console.log('RIX: data loaded from sheet', db.length, new Date().toISOString());
  } catch (err) {
    console.warn('RIX: fetch failed, loading cache', err);
    const cache = localStorage.getItem('rix_db_v1');
    db = cache ? JSON.parse(cache) : [];
    postBoot();
  }
}

/* call boot now */
boot();

/* manual refresh */
document.getElementById('refreshBtn').addEventListener('click', ()=>{
  document.getElementById('refreshBtn').disabled = true;
  document.getElementById('refreshBtn').innerText = 'Refreshing...';
  boot().finally(()=>{ document.getElementById('refreshBtn').disabled = false; document.getElementById('refreshBtn').innerText = 'Refresh'; });
});

/* admin toggle (convenience) */
document.getElementById('adminToggle').addEventListener('click', ()=>{
  location.hash = (location.hash === '#admin') ? '' : '#admin';
  location.reload();
});

/* post-boot logic */
function postBoot(){
  sanitizeAndNormalize();
  applyPremiumExpiry();
  renderStats();
  renderCityChips();
  view = [...db];
  renderDirectory();
  // analytics hook
  console.log('RIX_VIEW', {count: db.length, time: new Date().toISOString()});
}

/* ensure consistent shapes and defaults */
function sanitizeAndNormalize(){
  db = db.map((r, idx) => {
    // ensure required columns exist with safe values
    return {
      ShopID: s(r.ShopID) || ('RIX-' + (idx+1).toString().padStart(4,'0')),
      "Shop name": s(r["Shop name"]) || '',
      Category: s(r.Category) || 'Industrial',
      Industry: s(r.Industry) || '',
      Size: s(r.Size) || '',
      Location: s(r.Location) || '',
      City: s(r.City) || 'Raebareli',
      "Phone No.": s(r["Phone No."]) || '',
      Verified: s(r.Verified).toLowerCase() === 'yes' ? 'yes' : '',
      Premium: s(r.Premium).toLowerCase() === 'yes' ? 'yes' : '',
      PremiumExpiry: s(r.PremiumExpiry) || '',
      Rating: (r.Rating === undefined || r.Rating === '') ? 0 : Number(r.Rating),
      Reviews: (r.Reviews === undefined || r.Reviews === '') ? 0 : Number(r.Reviews),
      AgentID: s(r.AgentID) || '',
      AgentCommission: num(r.AgentCommission),
      PaymentStatus: s(r.PaymentStatus).toLowerCase() || '' // expected 'paid' or 'pending'
    };
  });
}

/* expiry processing & premium validity (considers PaymentStatus) */
function applyPremiumExpiry(){
  const now = new Date();
  db.forEach(item => {
    // if premium flagged
    if(item.Premium === 'yes') {
      // payment required for premium to be 'active'
      if(item.PaymentStatus !== 'paid') {
        item._premiumState = 'pending'; // awaiting payment
      } else if(item.PremiumExpiry) {
        const expiry = new Date(item.PremiumExpiry + 'T23:59:59');
        if(expiry < now) {
          item._premiumState = 'expired';
        } else {
          item._premiumState = 'active';
          // compute days left
          item._daysLeft = Math.ceil((expiry - now) / (1000*60*60*24));
        }
      } else {
        // no expiry date -> treat as active if paid
        item._premiumState = (item.PaymentStatus === 'paid') ? 'active' : 'pending';
      }
    } else {
      item._premiumState = 'none';
    }
  });
}

/* stats */
function renderStats(){
  const total = db.length;
  const verified = db.filter(x => x.Verified === 'yes').length;
  const premiumActive = db.filter(x => x._premiumState === 'active').length;
  const cities = new Set(db.map(x => x.City));
  document.getElementById('totalCount').textContent = total;
  document.getElementById('verifiedCount').textContent = verified;
  document.getElementById('premiumCount').textContent = premiumActive;
  document.getElementById('cityCount').textContent = cities.size;
}

/* city filter chips */
function renderCityChips(){
  const cities = ['All', ...Array.from(new Set(db.map(x => x.City)))];
  const root = document.getElementById('cityFilters');
  root.innerHTML = cities.map(c => `<div class="chip ${c===currentCity ? 'active' : ''}" onclick="selectCity('${escapeHtml(c)}')">${escapeHtml(c)}</div>`).join('');
}

/* select city */
function selectCity(c){
  currentCity = c;
  // reapply search filter using current query
  const q = document.getElementById('searchInput').value || '';
  searchEngine(q);
  renderCityChips();
}

/* escape helper (simple) */
function escapeHtml(str){ return (str||'').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* search & filter */
function searchEngine(q){
  q = (q || '').toString().toLowerCase().trim();
  view = db.filter(item => {
    const cityMatch = (currentCity === 'All' || item.City === currentCity);
    if(!cityMatch) return false;
    // safe fields
    const hay = (item["Shop name"] + ' ' + item.Category + ' ' + item.Industry + ' ' + item.Location + ' ' + item.City).toLowerCase();
    return hay.includes(q);
  });
  renderDirectory();
}

/* priority: active premium (paid) > none > pending > expired (lowest) */
function priorityScore(item){
  if(item._premiumState === 'active') return 3;
  if(item._premiumState === 'none') return 2;
  if(item._premiumState === 'pending') return 1;
  if(item._premiumState === 'expired') return 0;
  return 2;
}

/* generate stars safely */
function generateStars(n){
  const r = Math.max(0, Math.min(5, Math.round(Number(n) || 0)));
  return '‚òÖ'.repeat(r) + '‚òÜ'.repeat(5 - r);
}

/* safe phone link builder */
function phoneLink(phone){
  const d = sanitizePhone(phone);
  if(!d) return '#';
  return `tel:${d.length===10 ? d : '+91' + d}`;
}
function waLink(phone, shop){
  const d = sanitizePhone(phone);
  const text = encodeURIComponent(`Inquiry via RIX for ${shop}`);
  if(!d) return `https://wa.me/?text=${text}`;
  // ensure international format for wa.me: use country code (91) + number without plus
  const full = (d.length===10) ? ('91' + d) : d;
  return `https://wa.me/${full}?text=${text}`;
}

/* render directory */
function renderDirectory(){
  const root = document.getElementById('list');
  if(!view || view.length === 0){
    root.innerHTML = `<div style="text-align:center;padding:80px 20px;color:var(--muted)">No businesses found.</div>`;
    return;
  }

  // non-destructive sort
  const sorted = [...view].sort((a,b) => priorityScore(b) - priorityScore(a));

  root.innerHTML = sorted.map(item => {
    const premiumBadge = (item._premiumState === 'active') ? 'üíé' : '';
    const premiumClass = (item._premiumState === 'active') ? 'premium' : '';
    const verifiedTag = item.Verified === 'yes' ? `<span class="tag verified">Verified ‚úì</span>` : '';
    const expiredTag = item._premiumState === 'expired' ? `<span class="tag expired">Expired</span>` : '';
    const pendingTag = item._premiumState === 'pending' ? `<span class="tag">Pending Payment</span>` : '';
    const daysLeft = item._premiumState === 'active' && item._daysLeft ? `<span class="tag">Ends in ${item._daysLeft}d</span>` : '';
    const rating = Number(item.Rating) || 0;
    const reviews = Number(item.Reviews) || 0;

    // admin info visibility
    const adminHtml = (isAdmin && item.AgentID) ? `
      <div class="admin-box">
        AGENT: ${escapeHtml(item.AgentID)} ¬∑ COMMISSION: ‚Çπ${escapeHtml(String(item.AgentCommission || 0))} ¬∑ PAYMENT: ${escapeHtml(item.PaymentStatus || 'pending')}
      </div>
    ` : '';

    return `
      <div class="card ${premiumClass}">
        <div class="title">${escapeHtml(item["Shop name"])} ${premiumBadge}</div>
        <div class="loc">üìç ${escapeHtml(item.Location)} ‚Ä¢ ${escapeHtml(item.City)}</div>

        <div class="tag-row">
          <div class="tag">${escapeHtml(item.Category)}</div>
          <div class="tag">${escapeHtml(item.Industry || 'General')}</div>
          ${verifiedTag}
          ${daysLeft}${expiredTag}${pendingTag}
        </div>

        <div class="rating">
          <div class="stars">${generateStars(rating)}</div>
          <div class="muted" style="color:var(--muted)">${reviews} reviews</div>
        </div>

        <div class="actions">
          <a class="call" href="${phoneLink(item["Phone No."])}">CALL</a>
          <a class="wa" href="${waLink(item["Phone No."], item["Shop name"])}">üí¨</a>
        </div>

        ${adminHtml}
      </div>
    `;
  }).join('');
}

/* Initialize view when data present */
(function waitForData(){
  // if db loaded already, postBoot was called; still ensure view/render
  if(db && db.length) { view = [...db]; renderDirectory(); }
  // else nothing ‚Äî boot() will call render when done
})();

/* Small UX: auto-update expiry countdown every 12h (no background jobs; client-side only) */
setInterval(()=>{ applyPremiumExpiry(); renderStats(); renderDirectory(); }, 1000 * 60 * 60 * 12);

/* Quick safety: expose a console helper for you (only when admin) */
if(isAdmin){
  window.RIX = { db, refresh: ()=>boot(false), view };
  console.log('RIX admin mode enabled ‚Äî window.RIX available');
}

/* end */
</script>
</body>
</html>
