<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>RIX | Raebareli Industrial Exchange</title>

<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
:root{
  --bg:#020617; --card:#0f172a; --text:#f8fafc; --muted:#94a3b8;
  --border:rgba(255,255,255,.08); --primary:#3b82f6; --gold:#fbbf24; --green:#10b981;
}
*{box-sizing:border-box; -webkit-tap-highlight-color:transparent;}
body{ margin:0; background:var(--bg); color:var(--text); font-family:'Plus Jakarta Sans',sans-serif; padding-bottom:100px; }

header{ text-align:center; padding:60px 16px 30px; background:radial-gradient(circle at top right, #172554 0%, #020617 100%); border-bottom:1px solid var(--border); }
h1{font-size:48px; font-weight:800; margin:0; letter-spacing:-2px;}
.subtitle{color:var(--muted); font-size:12px; letter-spacing:2px; font-weight:700; margin-top:5px;}

.controls{ position:sticky; top:0; z-index:100; background:rgba(2, 6, 23, 0.9); backdrop-filter:blur(15px); padding:15px; border-bottom:1px solid var(--border); }
input, select{ width:100%; padding:14px; border-radius:14px; border:1px solid var(--border); background:var(--card); color:white; margin-bottom:10px; font-size:16px; font-weight:600; }

#feed{ max-width:800px; margin:auto; padding:16px; display:grid; gap:16px; }
.card{ background:var(--card); border:1px solid var(--border); border-radius:24px; padding:24px; position:relative; overflow:hidden; }
.card.premium{ border:1px solid var(--gold); box-shadow:0 0 20px rgba(251,191,36,0.1); }
.card.premium::after{ content:'PREMIUM'; position:absolute; top:0; right:0; background:var(--gold); color:#000; font-size:9px; font-weight:900; padding:4px 12px; border-bottom-left-radius:12px; }

.title{font-size:22px; font-weight:800; margin-bottom:4px;}
.loc{font-size:14px; color:var(--muted); margin-bottom:15px; display:flex; align-items:center; gap:5px;}
.tags{display:flex; gap:8px; flex-wrap:wrap; margin-bottom:20px;}
.tag{ font-size:11px; padding:5px 12px; border-radius:8px; background:rgba(255,255,255,0.04); border:1px solid var(--border); color:var(--muted); font-weight:600; }
.tag.ver{color:var(--green); border-color:rgba(16,185,129,.3); background:rgba(16,185,129,0.05);}

.actions{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
.btn{ padding:15px; border-radius:14px; text-align:center; text-decoration:none; font-weight:800; font-size:14px; border:none; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px; }
.call{background:#1e293b; color:white; border:1px solid var(--border);}
.wa{background:var(--primary); color:white;}

.admin-panel{ display:none; background:#000; padding:20px; border-bottom:2px solid var(--primary); }
.stat-grid{ display:grid; grid-template-columns:repeat(2, 1fr); gap:10px; }
.stat-box{ background:#111; padding:15px; border-radius:15px; border:1px solid #333; }
.stat-box small{ font-size:10px; color:#666; text-transform:uppercase; }
.stat-box div{ font-size:24px; font-weight:800; margin-top:5px; }
.admin-row{ font-family:monospace; font-size:11px; color:var(--muted); margin-top:15px; padding-top:10px; border-top:1px dashed #333; }

nav{ position:fixed; bottom:20px; left:20px; right:20px; background:rgba(15, 23, 42, 0.9); backdrop-filter:blur(20px); border:1px solid var(--border); border-radius:25px; display:flex; justify-content:space-around; align-items:center; padding:15px; z-index:2000; box-shadow:0 10px 40px rgba(0,0,0,0.5); }
.nav-btn{ font-size:24px; cursor:pointer; filter:grayscale(1); transition:0.2s; }
.nav-btn:active{ transform:scale(0.9); }

.loader { text-align:center; padding:50px; color:var(--muted); }
</style>
</head>
<body>

<div class="admin-panel" id="adminPanel">
  <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
    <h3 style="margin:0; color:var(--primary)">üõ°Ô∏è RIX COMMAND</h3>
    <button onclick="logout()" style="background:#333; color:white; border:none; padding:5px 10px; border-radius:8px; font-size:10px;">EXIT</button>
  </div>
  <div class="stat-grid">
    <div class="stat-box"><small>Total Units</small><div id="sTotal">0</div></div>
    <div class="stat-box"><small>Revenue</small><div id="sRev" style="color:var(--green)">‚Çπ0</div></div>
    <div class="stat-box"><small>Unpaid</small><div id="sUnpaid" style="color:var(--gold)">0</div></div>
    <div class="stat-box"><small>Expired</small><div id="sExp" style="color:var(--red)">0</div></div>
  </div>
</div>

<header>
  <h1>RIX</h1>
  <div class="subtitle">RAEBARELI INDUSTRIAL EXCHANGE</div>
</header>

<div class="controls">
  <input type="text" id="searchInput" placeholder="Search factory, area, or category..." oninput="search(this.value)">
  <select id="catFilter" onchange="filterCategory(this.value)">
    <option value="">All Categories</option>
  </select>
</div>

<main id="feed">
  <div class="loader">ESTABLISHING SECURE CONNECTION...</div>
</main>

<nav>
  <div class="nav-btn" onclick="window.scrollTo({top:0, behavior:'smooth'})" style="filter:none">üè†</div>
  <a href="https://wa.me/918146518503?text=Add%20My%20Business" style="background:var(--primary); color:white; width:55px; height:55px; border-radius:50%; display:flex; align-items:center; justify-content:center; text-decoration:none; margin-top:-45px; border:6px solid var(--bg); font-weight:800; font-size:28px;">+</a>
  <div class="nav-btn" onclick="shareApp()" style="filter:none">üì§</div>
  <div class="nav-btn" onclick="adminLogin()" style="filter:none">üõ°Ô∏è</div>
</nav>

<script>
// 1. CONFIGURATION
const SHEET_URL = "PASTE_YOUR_CSV_LINK_HERE";
const ADMIN_HASH = "86493664790089e9d6d87f7390ba038c82306716a50682701df93f0b2403251e"; // 'cutipie of ninth class'

let DB = [], VIEW = [], isAdmin = false;

// 2. DATA CORE
async function init() {
  // Try to load from cache first for offline speed
  const cached = localStorage.getItem('rix_data');
  if(cached) {
    DB = JSON.parse(cached);
    VIEW = [...DB];
    render();
    buildFilters();
  }

  // Always fetch fresh data if online
  Papa.parse(SHEET_URL, {
    download: true, header: true,
    complete: r => {
      DB = r.data.filter(x => x["Shop name"]);
      localStorage.setItem('rix_data', JSON.stringify(DB));
      VIEW = [...DB];
      render();
      buildFilters();
    }
  });
}

function buildFilters() {
  const sel = document.getElementById("catFilter");
  const cats = [...new Set(DB.map(x => x.Category))];
  sel.innerHTML = '<option value="">All Categories</option>' + 
    cats.map(c => `<option value="${c}">${c}</option>`).join('');
}

function search(q) {
  q = q.toLowerCase();
  VIEW = DB.filter(x => 
    x["Shop name"].toLowerCase().includes(q) || 
    x.Category.toLowerCase().includes(q) || 
    x.Location.toLowerCase().includes(q)
  );
  render();
}

function filterCategory(c) {
  VIEW = c ? DB.filter(x => x.Category === c) : DB;
  render();
}

// 3. RENDER ENGINE
function render() {
  const container = document.getElementById("feed");
  if(VIEW.length === 0) { container.innerHTML = '<div class="loader">No results found.</div>'; return; }

  container.innerHTML = VIEW.map(x => {
    const isPaid = x.PaymentStatus === "paid";
    const isPrem = x.Premium === "yes" && isPaid;
    const wa = `https://wa.me/91${x["Phone No."].replace(/\D/g,'')}?text=Hi, I saw your factory on RIX. I want to inquire about your services.`;

    const adminInfo = isAdmin ? `
      <div class="admin-row">
        AGENT: ${x.AgentID || 'Direct'} | COM: ‚Çπ${x.AgentCommission || 0} | PAID: ${x.PaymentStatus}
      </div>` : '';

    return `
      <div class="card ${isPrem ? 'premium' : ''}">
        <div class="title">${x["Shop name"]}</div>
        <div class="loc">üìç ${x.Location}, ${x.City || 'Raebareli'}</div>
        <div class="tags">
          <span class="tag">${x.Category}</span>
          ${x.Verified === "yes" ? '<span class="tag ver">VERIFIED ‚úì</span>' : ''}
          <span class="tag">‚≠ê ${x.Rating || 'New'}</span>
        </div>
        <div class="actions">
          <a class="btn call" href="tel:${x["Phone No."]}">üìû CALL</a>
          <a class="btn wa" href="${wa}">üí¨ WHATSAPP</a>
        </div>
        ${adminInfo}
      </div>
    `;
  }).join('');

  if(isAdmin) updateAdminStats();
}

// 4. SECURITY & ADMIN
async function adminLogin() {
  if(isAdmin) return;
  const p = prompt("ENTER SYSTEM PASSWORD:");
  if(!p) return;
  
  const h = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(p));
  const hex = [...new Uint8Array(h)].map(b => b.toString(16).padStart(2, "0")).join("");
  
  if(hex === ADMIN_HASH) {
    isAdmin = true;
    document.getElementById("adminPanel").style.display = "block";
    render();
    alert("SYSTEM UNLOCKED");
  } else {
    alert("ACCESS DENIED");
  }
}

function updateAdminStats() {
  document.getElementById("sTotal").innerText = DB.length;
  const revenue = DB.reduce((sum, x) => sum + (Number(x.AgentCommission) || 0), 0);
  document.getElementById("sRev").innerText = "‚Çπ" + revenue;
  document.getElementById("sUnpaid").innerText = DB.filter(x => x.PaymentStatus !== 'paid').length;
  document.getElementById("sExp").innerText = DB.filter(x => x.Premium === 'expired').length;
}

function logout() {
  isAdmin = false;
  document.getElementById("adminPanel").style.display = "none";
  render();
}

function shareApp() {
  if(navigator.share) {
    navigator.share({ title: "RIX Raebareli", url: window.location.href });
  } else {
    alert("App Link: " + window.location.href);
  }
}

// 5. PWA OFFLINE ENGINE
if ('serviceWorker' in navigator) {
  const sw = `
    const C = 'rix-v2';
    self.addEventListener('install', e => e.waitUntil(caches.open(C).then(c => c.addAll(['./']))));
    self.addEventListener('fetch', e => e.respondWith(caches.match(e.request).then(r => r || fetch(e.request))));
  `;
  const b = new Blob([sw], {type: 'application/javascript'});
  navigator.serviceWorker.register(URL.createObjectURL(b));
}

init();
</script>
</body>
</html>
